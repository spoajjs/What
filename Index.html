<!DOCTYPE html>
<html>
<head>
<title>Cards Game</title>
</head>
<body>
<h2>Cards Game</h2>
<div id="question"></div>
<div id="hand"></div>
<div id="played"></div>
<div id="votes"></div>
<script>
let user_id = prompt("Enter your Telegram user_id");
let nickname = prompt("Enter your nickname");

function fetchGame() {
    fetch(`/game_state/${user_id}`)
    .then(res => res.json())
    .then(update)
}

function update(data){
    if(!data.started){
        document.getElementById("question").innerText = "Waiting for the game to start...";
        document.getElementById("hand").innerHTML = "";
        document.getElementById("played").innerHTML = "";
        document.getElementById("votes").innerHTML = "";
        return;
    }

    if(!data.joined){
        document.getElementById("question").innerText = "You did not join the game via Telegram.";
        document.getElementById("hand").innerHTML = "";
        return;
    }

    document.getElementById("question").innerText = "Black Card: " + data.current_black;

    let handDiv = document.getElementById("hand");
    handDiv.innerHTML = "";
    data.hand.forEach(c=>{
        let btn=document.createElement("button");
        btn.innerText=c;
        btn.onclick=()=>{
            fetch(`/play_card_web`, {
                method:"POST",
                headers:{'Content-Type':'application/json'},
                body:JSON.stringify({user_id:user_id, card:c, nickname:nickname})
            }).then(fetchGame)
        };
        handDiv.appendChild(btn);
    });

    document.getElementById("played").innerText = "Played Cards: " + JSON.stringify(data.played_cards);

    let votesDiv = document.getElementById("votes");
    votesDiv.innerHTML = "";
    if(data.voting_phase){
        data.played_cards.forEach((p,i)=>{
            let btn=document.createElement("button");
            btn.innerText=p.card+" ("+p.nickname+")";
            btn.onclick=()=> {
                fetch(`/vote_web`, {
                    method:"POST",
                    headers:{'Content-Type':'application/json'},
                    body:JSON.stringify({user_id:user_id, vote_index:i})
                }).then(fetchGame)
            }
            votesDiv.appendChild(btn)
        })
    }
}

setInterval(fetchGame,1000)
</script>
</body>
</html>
